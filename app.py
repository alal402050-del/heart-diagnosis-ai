"""
Single-file Heart Diagnosis AI app (FastAPI) with embedded model + embedded HTML UI.
Folder contains only:
- app.py
- requirements.txt
"""

from fastapi import FastAPI
from fastapi.responses import HTMLResponse, JSONResponse
from pydantic import BaseModel, Field
import numpy as np
import joblib
from io import BytesIO
import base64

# ---- Embedded assets ----
_MODEL_PKL_B64 = "gASVKgEAAAAAAACME3NrbGVhcm4ubmFpdmVfYmF5ZXOUjApHYXVzc2lhbk5ClJOUKYGUfZQojAZwcmlvcnOUTowNdmFyX3Ntb290aGluZ5RHPhEuC+gm1pWMCGNsYXNzZXNflIwTam9ibGliLm51bXB5X3BpY2tsZZSMEU51bXB5QXJyYXlXcmFwcGVylJOUKYGUfZQojAhzdWJjbGFzc5SMBW51bXB5lIwHbmRhcnJheZSTlIwFc2hhcGWUSwKFlIwFb3JkZXKUjAFDlIwFZHR5cGWUaA6MBWR0eXBllJOUjAJpOJSJiIeUUpQoSwOMATyUTk5OSv////9K/////0sAdJRijAphbGxvd19tbWFwlIiMG251bXB5X2FycmF5X2FsaWdubWVudF9ieXRlc5RLEHViCv////////////8AAAAAAAAAAAEAAAAAAAAAlVsAAAAAAAAAjBFmZWF0dXJlX25hbWVzX2luX5RoCimBlH2UKGgNaBBoEUsUhZRoE2gUaBVoF4wCTziUiYiHlFKUKEsDjAF8lE5OTkr/////Sv////9LP3SUYmgdiWgeSxB1YoAFlbABAAAAAAAAjBZudW1weS5fY29yZS5tdWx0aWFycmF5lIwMX3JlY29uc3RydWN0lJOUjAVudW1weZSMB25kYXJyYXmUk5RLAIWUQwFilIeUUpQoSwFLFIWUaAOMBWR0eXBllJOUjAJPOJSJiIeUUpQoSwOMAXyUTk5OSv////9K/////0s/dJRiiV2UKIwDQWdllIwJUmVzdGluZ0JQlIwLQ2hvbGVzdGVyb2yUjAlGYXN0aW5nQlOUjAVNYXhIUpSMB09sZHBlYWuUjAVTZXhfRpSMBVNleF9NlIwRQ2hlc3RQYWluVHlwZV9BU1mUjBFDaGVzdFBhaW5UeXBlX0FUQZSMEUNoZXN0UGFpblR5cGVfTkFQlIwQQ2hlc3RQYWluVHlwZV9UQZSMDlJlc3RpbmdFQ0dfTFZIlIwRUmVzdGluZ0VDR19Ob3JtYWyUjA1SZXN0aW5nRUNHX1NUlIwQRXhlcmNpc2VBbmdpbmFfTpSMEEV4ZXJjaXNlQW5naW5hX1mUjA1TVF9TbG9wZV9Eb3dulIwNU1RfU2xvcGVfRmxhdJSMC1NUX1Nsb3BlX1VwlGV0lGIulaMAAAAAAAAAjA5uX2ZlYXR1cmVzX2luX5RLFIwIZXBzaWxvbl+UjBZudW1weS5fY29yZS5tdWx0aWFycmF5lIwGc2NhbGFylJOUaBeMAmY4lImIh5RSlChLA2gbTk5OSv////9K/////0sAdJRiQwgDo8WeI97nPpSGlFKUjAZ0aGV0YV+UaAopgZR9lChoDWgQaBFLAksUhpRoE2gUaBVoL2gdiGgeSxB1YgT/////dNFFF110SUC1fqVArT9gQNXhauQf42tARhdddNFFtz818o+x4pFiQGaEAPGyutk/W79SoNav1D9ToNavFKjlP3+lQK1fKdA/O0Ni3s6Q2D9h9/muLdPTPyP/GCselas/TU8Egyhpxj9YCtT6lQLlP1SHq5F/jMU/Jc3C7vNd6z9sy/REMIjCP3af79oyPaE/TU8Egyhpxj818o+x4lHpP9cOzLUD80tADYda9tTpYECJiIiIiKhmQEaJn1HiZ9Q/xv26pPLhX0A14+m4yvL0P88RKNpq8Lw/xv26pPJh7D+Icb8uqXzoP6vBcwSKtqo/F8lZ3wtwwT98AS6Ss76nP7cxBaF/dMs/HYGirQbP4T/VyXCoZU/NP3ZJ5cO4X9c/RVsNniNQ5D+3MQWhf3S7P4ZDLXvqZOg/C1nIQhaywD+VLAAAAAAAAACMBHZhcl+UaAopgZR9lChoDWgQaBFLAksUhpRoE2gUaBVoL2gdiGgeSxB1Ygr/////////////iSml/IN6VkAfbujdUidvQOX//GlJ/7ZA9Tn9t/EotT94Fg7boc6AQFbVDgHpEt8/In6zN3oAzD8ifrM3egDMP8sahaeJKcg/ENO0nDdGzj/V2wT0gl7LPyRstnA2Gqo/o4kFqgt9wj8bRgwpI93MPxfv3/Yq7ME/rmLzhmKzvz+uYvOGYrO/Px1q/AsZqqA/oIkFqgt9wj+QN2dB2yTFP27CUfR4SlNAybuULAXwekA8mFhNdOLNQC0NmPb3zMs/Gvp5nkSrgEBjsjwh2JH0P2afBqOwq7k/Zp8Go7CruT8skWyQdv/GP4mN9c08U6k/U+eYN4wgvj+UUsBKSKamPydg0jlPkcU/J66GU7CXzz9ygd/QmZnGP12BiREZrc0/XYGJERmtzT9lgUGidoO4P07bU4GRMcc/GkNuyfAJvT+VMgAAAAAAAACMDGNsYXNzX2NvdW50X5RoCimBlH2UKGgNaBBoEUsChZRoE2gUaBVoL2gdiGgeSxB1YgT/////AAAAAACQckAAAAAAAJB1QJUyAAAAAAAAAIwMY2xhc3NfcHJpb3JflGgKKYGUfZQoaA1oEGgRSwKFlGgTaBRoFWgvaB2IaB5LEHViBP/////onbqWg5vdPwyxojQ+MuE/lR4AAAAAAAAAjBBfc2tsZWFybl92ZXJzaW9ulIwFMS43LjKUdWIu"

_HTML_PAGE = r"<!DOCTYPE html>\n<html lang=\"ar\" dir=\"rtl\">\n<head>\n  <meta charset=\"UTF-8\" />\n  <title>\u062a\u0648\u0642\u0651\u0639 \u0645\u0631\u0636 \u0627\u0644\u0642\u0644\u0628</title>\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\n  <style>\n    :root {\n      --bg: #0b1220;\n      --shell-bg: #020617;\n      --card-bg: #ffffff;\n      --primary: #2563eb;\n      --primary-soft: rgba(37, 99, 235, 0.08);\n      --primary-border: #bfdbfe;\n      --text-main: #0f172a;\n      --text-muted: #6b7280;\n      --border-soft: #e5e7eb;\n      --radius-xl: 18px;\n      --radius-lg: 12px;\n      --radius-md: 9px;\n      --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.25);\n    }\n    * { box-sizing: border-box; }\n    body {\n      margin: 0;\n      min-height: 100vh;\n      font-family: system-ui, -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif;\n      background: radial-gradient(circle at top, #1e293b 0, #020617 45%, #000 100%);\n      color: var(--text-main);\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      padding: 24px 12px;\n    }\n    .shell {\n      width: 100%;\n      max-width: 980px;\n      background: radial-gradient(circle at top left, #111827, #020617 55%);\n      border-radius: 24px;\n      padding: 18px;\n      box-shadow: 0 16px 50px rgba(15, 23, 42, 0.6);\n      border: 1px solid rgba(148, 163, 184, 0.25);\n    }\n    .shell-header {\n      display: flex;\n      align-items: center;\n      justify-content: space-between;\n      gap: 12px;\n      margin-bottom: 14px;\n      color: #e5e7eb;\n    }\n    .shell-title { display: flex; align-items: center; gap: 10px; }\n    .shell-logo {\n      width: 30px; height: 30px; border-radius: 9px;\n      background: conic-gradient(from 210deg, #60a5fa, #22d3ee, #4ade80, #60a5fa);\n      display: flex; align-items: center; justify-content: center;\n      font-size: 0.9rem; font-weight: 700; color: #0b1120;\n      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.6);\n    }\n    .shell-main-title { display: flex; flex-direction: column; gap: 2px; }\n    .shell-main-title strong {\n      font-size: 0.88rem; letter-spacing: 0.08em; text-transform: uppercase;\n    }\n    .shell-main-title span { font-size: 0.75rem; color: #9ca3af; }\n    .shell-right { display: flex; align-items: center; gap: 8px; font-size: 0.75rem; }\n    .pill {\n      padding: 3px 10px; border-radius: 999px;\n      border: 1px solid rgba(148, 163, 184, 0.45);\n      display: inline-flex; align-items: center; gap: 6px;\n      background: rgba(15, 23, 42, 0.7); color: #e5e7eb;\n    }\n    .pill-dot {\n      width: 7px; height: 7px; border-radius: 999px;\n      background: #22c55e; box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.3);\n    }\n    .pill-tag {\n      padding: 3px 9px; border-radius: 999px;\n      border: 1px solid rgba(129, 140, 248, 0.5);\n      background: rgba(30, 64, 175, 0.6); color: #e5e7eb;\n    }\n    .layout { display: grid; grid-template-columns: 3fr 2fr; gap: 14px; }\n    @media (max-width: 860px) {\n      .shell { padding: 14px; }\n      .layout { grid-template-columns: 1fr; }\n    }\n    .card {\n      background: var(--card-bg); border-radius: var(--radius-xl);\n      padding: 18px 18px 16px; box-shadow: var(--shadow-soft);\n      position: relative; overflow: hidden;\n    }\n    .card::before {\n      content: \"\"; position: absolute; inset: 0;\n      background:\n        radial-gradient(circle at -10% -10%, rgba(37,99,235,0.07), transparent 55%),\n        radial-gradient(circle at 120% 10%, rgba(59,130,246,0.05), transparent 60%);\n      pointer-events: none; z-index: 0;\n    }\n    .card-inner { position: relative; z-index: 1; }\n    .card-header { margin-bottom: 14px; }\n    .card-header-main {\n      display: flex; align-items: flex-start; justify-content: space-between; gap: 10px;\n    }\n    .card-title-group { display: flex; flex-direction: column; gap: 4px; }\n    h1 { margin: 0; font-size: 1.1rem; font-weight: 700; letter-spacing: 0.01em; color: #0f172a; }\n    .subtitle { margin: 0; font-size: 0.82rem; color: var(--text-muted); }\n    .card-header-meta {\n      margin-top: 8px; font-size: 0.75rem; color: #9ca3af;\n      display: flex; flex-wrap: wrap; gap: 6px 14px;\n    }\n    .card-header-meta span { display: inline-flex; align-items: center; gap: 4px; }\n    .meta-dot { width: 7px; height: 7px; border-radius: 999px; background: #38bdf8; }\n    form { margin-top: 6px; }\n    .section {\n      border-radius: var(--radius-lg); border: 1px solid var(--border-soft);\n      background: rgba(248,250,252,0.8);\n      padding: 10px 12px 8px; margin-bottom: 10px;\n    }\n    .section-header {\n      display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;\n    }\n    .section-title {\n      font-size: 0.82rem; font-weight: 600; color: #111827;\n      display: inline-flex; align-items: center; gap: 6px;\n    }\n    .section-title-badge {\n      font-size: 0.7rem; padding: 2px 8px; border-radius: 999px;\n      border: 1px solid rgba(148,163,184,0.65); color: #6b7280; background: #f9fafb;\n    }\n    .section-title-icon {\n      width: 18px; height: 18px; border-radius: 999px;\n      background: rgba(37,99,235,0.1);\n      display: inline-flex; align-items: center; justify-content: center;\n      font-size: 0.75rem; color: #1d4ed8;\n    }\n    .grid { display: grid; grid-template-columns: 1fr; gap: 8px; }\n    @media (min-width: 640px) {\n      .grid[data-cols=\"2\"] { grid-template-columns: repeat(2, minmax(0,1fr)); }\n    }\n    .field { font-size: 0.85rem; display: flex; flex-direction: column; gap: 4px; }\n    .field.full { grid-column: 1 / -1; }\n    label {\n      font-weight: 600; color: #111827; font-size: 0.8rem;\n      display: flex; align-items: center; justify-content: space-between; gap: 6px;\n    }\n    .label-main { display: inline-flex; align-items: center; gap: 6px; }\n    label span.en { font-weight: 500; color: var(--text-muted); font-size: 0.75rem; }\n    .label-hint { font-size: 0.7rem; color: #9ca3af; }\n    input, select {\n      width: 100%; padding: 7px 9px; border-radius: 8px;\n      border: 1px solid var(--border-soft); font-size: 0.85rem;\n      background-color: rgba(255,255,255,0.95);\n      transition: border-color 0.15s ease, box-shadow 0.15s ease,\n        background-color 0.15s ease, transform 0.05s ease;\n      outline: none;\n    }\n    input::placeholder { color: #9ca3af; font-size: 0.78rem; }\n    input:focus, select:focus {\n      border-color: var(--primary);\n      box-shadow: 0 0 0 1px rgba(37,99,235,0.18), 0 0 0 8px rgba(37,99,235,0.08);\n      background-color: #ffffff; transform: translateY(-1px);\n    }\n    button {\n      width: 100%; margin-top: 10px; padding: 9px 10px; border-radius: 999px;\n      border: 1px solid #1d4ed8;\n      background: linear-gradient(135deg, #2563eb, #1d4ed8);\n      color: #ffffff; font-size: 0.9rem; font-weight: 600;\n      cursor: pointer; display: inline-flex; align-items: center; justify-content: center;\n      gap: 8px; letter-spacing: 0.02em;\n      transition: transform 0.1s ease, box-shadow 0.1s ease, opacity 0.1s ease, filter 0.1s ease;\n      box-shadow: 0 12px 26px rgba(37,99,235,0.4);\n    }\n    button span.icon { font-size: 1rem; line-height: 1; }\n    button:hover:not(:disabled) {\n      transform: translateY(-1px); filter: brightness(1.03);\n      box-shadow: 0 16px 32px rgba(37,99,235,0.44);\n    }\n    button:active:not(:disabled) {\n      transform: translateY(0); box-shadow: 0 9px 20px rgba(37,99,235,0.34);\n    }\n    button:disabled { opacity: 0.7; cursor: default; box-shadow: none; }\n    .footer-note {\n      margin-top: 10px; font-size: 0.75rem; color: var(--text-muted); line-height: 1.6;\n    }\n    .footer-note strong { color: #111827; font-weight: 600; }\n    .side-card {\n      border-radius: var(--radius-xl);\n      border: 1px solid rgba(148,163,184,0.35);\n      background: radial-gradient(circle at top, rgba(15,23,42,0.95), #020617);\n      color: #e5e7eb; padding: 16px 16px 14px;\n      display: flex; flex-direction: column; justify-content: space-between; gap: 16px;\n      position: relative; overflow: hidden;\n    }\n    .side-card::before {\n      content: \"\"; position: absolute; inset: 0;\n      background:\n        radial-gradient(circle at 10% -10%, rgba(59,130,246,0.32), transparent 55%),\n        radial-gradient(circle at 120% 0%, rgba(56,189,248,0.24), transparent 60%);\n      opacity: 0.9; pointer-events: none; z-index: 0;\n    }\n    .side-inner { position: relative; z-index: 1; }\n    .side-header { margin-bottom: 10px; }\n    .side-title { font-size: 0.9rem; font-weight: 600; margin: 0 0 4px; }\n    .side-sub { margin: 0; font-size: 0.78rem; color: #cbd5f5; }\n    .result {\n      margin-top: 6px; padding: 10px 11px; border-radius: var(--radius-lg);\n      font-size: 0.84rem; background: rgba(15,23,42,0.9);\n      border: 1px solid rgba(148,163,184,0.5); display: none;\n    }\n    .result-header {\n      display: flex; align-items: center; justify-content: space-between;\n      margin-bottom: 6px; gap: 10px;\n    }\n    .result-label { font-weight: 600; font-size: 0.82rem; }\n    .result-badge {\n      padding: 3px 9px; border-radius: 999px; font-size: 0.7rem;\n      border: 1px solid rgba(148,163,184,0.8);\n    }\n    .result-body { font-size: 0.8rem; color: #e5e7eb; line-height: 1.6; }\n    .result-range { margin-top: 8px; font-size: 0.76rem; color: #9ca3af; }\n    .result-range strong { color: #e5e7eb; }\n    .result--risk { background: rgba(127,29,29,0.86); border-color: #fecaca; }\n    .result--low { background: rgba(22,101,52,0.9); border-color: #bbf7d0; }\n    .result--risk .result-range strong { color: #fee2e2; }\n    .result--low .result-range strong { color: #dcfce7; }\n    .side-list {\n      margin-top: 10px; padding: 9px 10px; border-radius: var(--radius-md);\n      background: rgba(15,23,42,0.8);\n      border: 1px solid rgba(148,163,184,0.4); font-size: 0.76rem; color: #cbd5f5;\n    }\n    .side-list ul { margin: 6px 0 0; padding-right: 18px; }\n    .side-list li { margin-bottom: 3px; }\n    .side-footer { font-size: 0.72rem; color: #9ca3af; line-height: 1.7; }\n  </style>\n</head>\n<body>\n  <div class=\"shell\">\n    <div class=\"shell-header\">\n      <div class=\"shell-title\">\n        <div class=\"shell-logo\">HR</div>\n        <div class=\"shell-main-title\">\n          <strong>HEART RISK STUDIO</strong>\n          <span>Clinical decision support \u00b7 Beta</span>\n        </div>\n      </div>\n      <div class=\"shell-right\">\n        <div class=\"pill\">\n          <span class=\"pill-dot\"></span>\n          <span>\u0627\u0644\u0646\u0645\u0648\u0630\u062c \u0645\u062a\u0635\u0644 \u0648\u064a\u0639\u0645\u0644</span>\n        </div>\n        <div class=\"pill-tag\">\u0625\u0635\u062f\u0627\u0631 \u062a\u062c\u0631\u064a\u0628\u064a</div>\n      </div>\n    </div>\n\n    <div class=\"layout\">\n      <div class=\"card\">\n        <div class=\"card-inner\">\n          <div class=\"card-header\">\n            <div class=\"card-header-main\">\n              <div class=\"card-title-group\">\n                <h1>\u0646\u0645\u0648\u0630\u062c \u062a\u0648\u0642\u0651\u0639 \u0645\u0631\u0636 \u0627\u0644\u0642\u0644\u0628</h1>\n                <p class=\"subtitle\">\n                  \u0623\u062f\u062e\u0644 \u0627\u0644\u0628\u064a\u0627\u0646\u0627\u062a \u0627\u0644\u0633\u0631\u064a\u0631\u064a\u0629 \u0627\u0644\u0623\u0633\u0627\u0633\u064a\u0629 \u0644\u0644\u062d\u0635\u0648\u0644 \u0639\u0644\u0649 \u062a\u0642\u062f\u064a\u0631 \u0627\u062d\u062a\u0645\u0627\u0644\u064a\u0629 \u0648\u062c\u0648\u062f \u062e\u0637\u0631 \u0646\u0633\u0628\u064a.\n                </p>\n              </div>\n            </div>\n            <div class=\"card-header-meta\">\n              <span><span class=\"meta-dot\"></span> \u0622\u062e\u0631 \u062a\u062d\u062f\u064a\u062b: 2025</span>\n              <span>\u0646\u0645\u0648\u0630\u062c \u062a\u0635\u0646\u064a\u0641\u064a \u062b\u0646\u0627\u0626\u064a (\u062e\u0637\u0631 / \u062e\u0637\u0631 \u0645\u0646\u062e\u0641\u0636)</span>\n            </div>\n          </div>\n\n          <form id=\"form\">\n            <div class=\"section\">\n              <div class=\"section-header\">\n                <div class=\"section-title\">\n                  <span class=\"section-title-icon\">\u2460</span>\n                  <span>\u0627\u0644\u0628\u064a\u0627\u0646\u0627\u062a \u0627\u0644\u0623\u0633\u0627\u0633\u064a\u0629</span>\n                </div>\n                <div class=\"section-title-badge\">Required</div>\n              </div>\n\n              <div class=\"grid\" data-cols=\"2\">\n                <div class=\"field\">\n                  <label for=\"age\">\n                    <span class=\"label-main\">\n                      \u0627\u0644\u0639\u0645\u0631\n                      <span class=\"en\">(Age)</span>\n                    </span>\n                  </label>\n                  <input id=\"age\" type=\"number\" min=\"1\" placeholder=\"\u0645\u062b\u0627\u0644: 52\" required />\n                </div>\n\n                <div class=\"field\">\n                  <label for=\"sex\">\n                    <span class=\"label-main\">\n                      \u0627\u0644\u062c\u0646\u0633\n                      <span class=\"en\">(Sex)</span>\n                    </span>\n                  </label>\n                  <select id=\"sex\" required>\n                    <option value=\"\">\u0627\u062e\u062a\u0631 \u0627\u0644\u062c\u0646\u0633</option>\n                    <option value=\"M\">\u0630\u0643\u0631</option>\n                    <option value=\"F\">\u0623\u0646\u062b\u0649</option>\n                  </select>\n                </div>\n\n                <div class=\"field full\">\n                  <label for=\"cp\">\n                    <span class=\"label-main\">\n                      \u0646\u0648\u0639 \u0623\u0644\u0645 \u0627\u0644\u0635\u062f\u0631\n                      <span class=\"en\">(ChestPainType)</span>\n                    </span>\n                    <span class=\"label-hint\">ATA / NAP / ASY / TA</span>\n                  </label>\n                  <select id=\"cp\" required>\n                    <option value=\"\">\u0627\u062e\u062a\u0631 \u0646\u0648\u0639 \u0627\u0644\u0623\u0644\u0645</option>\n                    <option value=\"ATA\">ATA</option>\n                    <option value=\"NAP\">NAP</option>\n                    <option value=\"ASY\">ASY</option>\n                    <option value=\"TA\">TA</option>\n                  </select>\n                </div>\n              </div>\n            </div>\n\n            <div class=\"section\">\n              <div class=\"section-header\">\n                <div class=\"section-title\">\n                  <span class=\"section-title-icon\">\u2461</span>\n                  <span>\u0628\u064a\u0627\u0646\u0627\u062a \u0627\u0644\u0641\u062d\u0648\u0635\u0627\u062a</span>\n                </div>\n                <div class=\"section-title-badge\">Clinical inputs</div>\n              </div>\n\n              <div class=\"grid\" data-cols=\"2\">\n                <div class=\"field\">\n                  <label for=\"bp\">\n                    <span class=\"label-main\">\n                      \u0636\u063a\u0637 \u0627\u0644\u0631\u0627\u062d\u0629\n                      <span class=\"en\">(RestingBP)</span>\n                    </span>\n                    <span class=\"label-hint\">mm Hg</span>\n                  </label>\n                  <input id=\"bp\" type=\"number\" min=\"0\" placeholder=\"\u0645\u062b\u0627\u0644: 120\" required />\n                </div>\n\n                <div class=\"field\">\n                  <label for=\"chol\">\n                    <span class=\"label-main\">\n                      \u0627\u0644\u0643\u0648\u0644\u064a\u0633\u062a\u0631\u0648\u0644\n                      <span class=\"en\">(Cholesterol)</span>\n                    </span>\n                    <span class=\"label-hint\">mg/dL</span>\n                  </label>\n                  <input id=\"chol\" type=\"number\" min=\"0\" placeholder=\"\u0645\u062b\u0627\u0644: 200\" required />\n                </div>\n\n                <div class=\"field\">\n                  <label for=\"maxhr\">\n                    <span class=\"label-main\">\n                      \u0623\u0642\u0635\u0649 \u0646\u0628\u0636\n                      <span class=\"en\">(MaxHR)</span>\n                    </span>\n                    <span class=\"label-hint\">\u0646\u0628\u0636\u0629/\u062f\u0642\u064a\u0642\u0629</span>\n                  </label>\n                  <input id=\"maxhr\" type=\"number\" min=\"0\" placeholder=\"\u0645\u062b\u0627\u0644: 150\" required />\n                </div>\n\n                <div class=\"field\">\n                  <label for=\"exang\">\n                    <span class=\"label-main\">\n                      \u0630\u0628\u062d\u0629 \u0645\u0639 \u0627\u0644\u0645\u062c\u0647\u0648\u062f\n                      <span class=\"en\">(ExerciseAngina)</span>\n                    </span>\n                  </label>\n                  <select id=\"exang\" required>\n                    <option value=\"\">\u0647\u0644 \u062a\u0638\u0647\u0631 \u0645\u0639 \u0627\u0644\u0645\u062c\u0647\u0648\u062f\u061f</option>\n                    <option value=\"N\">\u0644\u0627</option>\n                    <option value=\"Y\">\u0646\u0639\u0645</option>\n                  </select>\n                </div>\n\n                <div class=\"field\">\n                  <label for=\"oldpeak\">\n                    <span class=\"label-main\">\n                      Oldpeak\n                    </span>\n                    <span class=\"label-hint\">ST depression</span>\n                  </label>\n                  <input id=\"oldpeak\" type=\"number\" step=\"0.1\" placeholder=\"\u0645\u062b\u0627\u0644: 1.2\" required />\n                </div>\n\n                <div class=\"field\">\n                  <label for=\"stslope\">\n                    <span class=\"label-main\">\n                      \u0645\u064a\u0644 \u0634\u0631\u064a\u062d\u0629 ST\n                      <span class=\"en\">(ST_Slope)</span>\n                    </span>\n                  </label>\n                  <select id=\"stslope\" required>\n                    <option value=\"\">\u0627\u062e\u062a\u0631 \u0627\u0644\u0645\u064a\u0644</option>\n                    <option value=\"Up\">Up</option>\n                    <option value=\"Flat\">Flat</option>\n                    <option value=\"Down\">Down</option>\n                  </select>\n                </div>\n              </div>\n            </div>\n\n            <button type=\"submit\" id=\"btn\">\n              <span class=\"icon\">\u23f5</span>\n              <span>\u062a\u0634\u063a\u064a\u0644 \u0627\u0644\u062a\u0648\u0642\u0651\u0639 \u0627\u0644\u0622\u0646</span>\n            </button>\n          </form>\n\n          <div class=\"footer-note\">\n            <strong>\u062a\u0646\u0628\u064a\u0647 \u0645\u0647\u0645:</strong>\n            \u0647\u0630\u0647 \u0627\u0644\u0623\u062f\u0627\u0629 \u0645\u062e\u0635\u0651\u0635\u0629 \u0644\u0623\u063a\u0631\u0627\u0636 \u062a\u0639\u0644\u064a\u0645\u064a\u0629 \u0648\u062f\u0627\u0639\u0645\u0629 \u0644\u0644\u0642\u0631\u0627\u0631 \u0641\u0642\u0637\u060c \u0648\u0644\u0627 \u062a\u064f\u0639\u062a\u0628\u064e\u0631 \u0628\u0623\u064a\n            \u0634\u0643\u0644 <strong>\u062a\u0634\u062e\u064a\u0635\u0627\u064b \u0637\u0628\u064a\u0627\u064b</strong> \u0623\u0648 \u0628\u062f\u064a\u0644\u0627\u064b \u0639\u0646 \u062a\u0642\u064a\u064a\u0645 \u0633\u0631\u064a\u0631\u064a \u0645\u0628\u0627\u0634\u0631 \u0645\u0646\n            \u0642\u0628\u0644 \u0637\u0628\u064a\u0628 \u0645\u062e\u062a\u0635.\n          </div>\n        </div>\n      </div>\n\n      <div class=\"side-card\">\n        <div class=\"side-inner\">\n          <div class=\"side-header\">\n            <h2 class=\"side-title\">\u0645\u0644\u062e\u0635 \u0627\u0644\u062a\u0648\u0642\u0651\u0639</h2>\n            <p class=\"side-sub\">\n              \u064a\u062a\u0645 \u062a\u062d\u062f\u064a\u062b \u0627\u0644\u0646\u062a\u064a\u062c\u0629 \u0645\u0628\u0627\u0634\u0631\u0629 \u0628\u0639\u062f \u0625\u062f\u062e\u0627\u0644 \u0627\u0644\u0628\u064a\u0627\u0646\u0627\u062a \u0648\u062a\u0634\u063a\u064a\u0644 \u0627\u0644\u0646\u0645\u0648\u0630\u062c.\n            </p>\n          </div>\n\n          <div id=\"result\" class=\"result\">\n            <div class=\"result-header\">\n              <div class=\"result-label\">\u062d\u0627\u0644\u0629 \u0627\u0644\u062e\u0637\u0631 \u0627\u0644\u0645\u062a\u0648\u0642\u0651\u0639\u0629</div>\n              <div class=\"result-badge\" id=\"result-badge\">\u2014</div>\n            </div>\n            <div class=\"result-body\" id=\"result-text\">\n              \u0644\u0645 \u064a\u062a\u0645 \u0627\u062d\u062a\u0633\u0627\u0628 \u0623\u064a \u0646\u062a\u064a\u062c\u0629 \u0628\u0639\u062f. \u0627\u0644\u0631\u062c\u0627\u0621 \u0625\u062f\u062e\u0627\u0644 \u0627\u0644\u0628\u064a\u0627\u0646\u0627\u062a \u062b\u0645 \u062a\u0634\u063a\u064a\u0644 \u0627\u0644\u062a\u0648\u0642\u0651\u0639.\n            </div>\n            <div class=\"result-range\" id=\"result-range\">\n              \u0627\u0644\u0646\u0633\u0628\u0629 \u0627\u0644\u062a\u0642\u0631\u064a\u0628\u064a\u0629: <strong>\u2014%</strong>\n            </div>\n          </div>\n\n          <div class=\"side-list\">\n            <div>\u0643\u064a\u0641\u064a\u0629 \u0642\u0631\u0627\u0621\u0629 \u0627\u0644\u0646\u062a\u064a\u062c\u0629:</div>\n            <ul>\n              <li>\u0627\u0644\u0646\u0633\u0628\u0629 \u062a\u0639\u0628\u0651\u0631 \u0639\u0646 <strong>\u0627\u062d\u062a\u0645\u0627\u0644 \u062a\u0642\u0631\u064a\u0628\u064a</strong> \u0644\u0648\u062c\u0648\u062f \u062e\u0637\u0631 \u0646\u0633\u0628\u064a.</li>\n              <li>\u0642\u064a\u0645\u0629 \u0623\u0639\u0644\u0649 \u0644\u0627 \u062a\u0639\u0646\u064a \u0628\u0627\u0644\u0636\u0631\u0648\u0631\u0629 \u0648\u062c\u0648\u062f \u0645\u0631\u0636 \u0645\u0624\u0643\u062f.</li>\n              <li>\u0623\u064a \u0646\u062a\u064a\u062c\u0629 \u0645\u0631\u062a\u0641\u0639\u0629 \u062a\u0633\u062a\u062f\u0639\u064a <strong>\u0645\u0631\u0627\u062c\u0639\u0629 \u0637\u0628\u064a\u0628</strong> \u0623\u0648 \u0623\u062e\u0635\u0627\u0626\u064a \u0642\u0644\u0628.</li>\n            </ul>\n          </div>\n\n          <div class=\"side-footer\">\n            \u0644\u0627 \u062a\u0642\u0645 \u0628\u0627\u062a\u062e\u0627\u0630 \u0623\u0648 \u0625\u064a\u0642\u0627\u0641 \u0623\u064a \u0639\u0644\u0627\u062c \u0627\u0639\u062a\u0645\u0627\u062f\u0627\u064b \u0639\u0644\u0649 \u0647\u0630\u0647 \u0627\u0644\u0623\u062f\u0627\u0629 \u0641\u0642\u0637. \u0623\u064a \u0642\u0631\u0627\u0631\n            \u0639\u0644\u0627\u062c\u064a \u064a\u062c\u0628 \u0623\u0646 \u064a\u0643\u0648\u0646 \u0645\u0628\u0646\u064a\u0627\u064b \u0639\u0644\u0649 \u062a\u0642\u064a\u064a\u0645 \u0633\u0631\u064a\u0631\u064a \u0643\u0627\u0645\u0644 \u0648\u062a\u062d\u0627\u0644\u064a\u0644 \u064a\u0637\u0644\u0628\u0647\u0627 \u0627\u0644\u0637\u0628\u064a\u0628.\n          </div>\n        </div>\n      </div>\n    </div>\n  </div>\n\n  <script>\n    const form = document.getElementById(\"form\");\n    const btn = document.getElementById(\"btn\");\n    const resultBox = document.getElementById(\"result\");\n    const resultText = document.getElementById(\"result-text\");\n    const resultBadge = document.getElementById(\"result-badge\");\n    const resultRange = document.getElementById(\"result-range\");\n\n    form.addEventListener(\"submit\", async (e) => {\n      e.preventDefault();\n      btn.disabled = true;\n\n      resultBox.style.display = \"block\";\n      resultBox.className = \"result\";\n      resultText.textContent = \"\u062c\u0627\u0631\u064a \u0627\u0644\u062d\u0633\u0627\u0628 \u0628\u0646\u0627\u0621\u064b \u0639\u0644\u0649 \u0627\u0644\u0628\u064a\u0627\u0646\u0627\u062a \u0627\u0644\u0645\u062f\u062e\u0644\u0629...\";\n      resultBadge.textContent = \"Processing\";\n      resultRange.innerHTML = '\u0627\u0644\u0646\u0633\u0628\u0629 \u0627\u0644\u062a\u0642\u0631\u064a\u0628\u064a\u0629: <strong>\u2014%</strong>';\n\n      const data = {\n        Age: Number(document.getElementById(\"age\").value),\n        Sex: document.getElementById(\"sex\").value,\n        ChestPainType: document.getElementById(\"cp\").value,\n        RestingBP: Number(document.getElementById(\"bp\").value),\n        Cholesterol: Number(document.getElementById(\"chol\").value),\n        MaxHR: Number(document.getElementById(\"maxhr\").value),\n        ExerciseAngina: document.getElementById(\"exang\").value,\n        Oldpeak: Number(document.getElementById(\"oldpeak\").value),\n        ST_Slope: document.getElementById(\"stslope\").value,\n      };\n\n      try {\n        \nconst response = await fetch(\"/predict\", {\n  method: \"POST\",\n  headers: { \"Content-Type\": \"application/json\" },\n  body: JSON.stringify(data),\n});\n\nconst result = await response.json();\n\nif (result.error) {\n  throw new Error(result.error);\n}\n\nconst prob = Math.max(0, Math.min(1, result.probability));\nconst label = result.label;\nconst percent = Math.round(prob * 100);\n(prob * 100);\n\n        if (label === 1) {\n          resultBox.className = \"result result--risk\";\n          resultBadge.textContent = \"\u062e\u0637\u0631 \u0646\u0633\u0628\u064a\";\n          resultText.textContent =\n            \"\u0627\u0644\u0646\u0645\u0648\u0630\u062c \u064a\u062a\u0648\u0642\u0651\u0639 \u0648\u062c\u0648\u062f \u0645\u0633\u062a\u0648\u0649 \u062e\u0637\u0631 \u0646\u0633\u0628\u064a \u064a\u062d\u062a\u0627\u062c \u0625\u0644\u0649 \u062a\u0642\u064a\u064a\u0645 \u0633\u0631\u064a\u0631\u064a \u0623\u062f\u0642. \u064a\u064f\u0641\u0636\u0651\u0644 \u062d\u062c\u0632 \u0645\u0648\u0639\u062f \u0645\u0639 \u0637\u0628\u064a\u0628 \u0642\u0644\u0628 \u0623\u0648 \u0637\u0628\u064a\u0628 \u0628\u0627\u0637\u0646\u064a \u0644\u0645\u0631\u0627\u062c\u0639\u0629 \u0627\u0644\u0646\u062a\u0627\u0626\u062c \u0648\u0627\u0644\u0641\u062d\u0648\u0635\u0627\u062a.\";\n        } else {\n          resultBox.className = \"result result--low\";\n          resultBadge.textContent = \"\u062e\u0637\u0631 \u0645\u0646\u062e\u0641\u0636 \u0646\u0633\u0628\u064a\u0627\u064b\";\n          resultText.textContent =\n            \"\u0627\u0644\u0646\u0645\u0648\u0630\u062c \u064a\u0634\u064a\u0631 \u0625\u0644\u0649 \u0645\u0633\u062a\u0648\u0649 \u062e\u0637\u0631 \u0645\u0646\u062e\u0641\u0636 \u0646\u0633\u0628\u064a\u0627\u064b \u0648\u0641\u0642\u0627\u064b \u0644\u0644\u0628\u064a\u0627\u0646\u0627\u062a \u0627\u0644\u0645\u062f\u062e\u0644\u0629. \u0645\u0639 \u0630\u0644\u0643\u060c \u0644\u0627 \u064a\u064f\u063a\u0646\u064a \u0647\u0630\u0627 \u0639\u0646 \u0627\u0644\u0645\u062a\u0627\u0628\u0639\u0629 \u0627\u0644\u062f\u0648\u0631\u064a\u0629 \u0648\u0627\u0644\u0627\u0644\u062a\u0632\u0627\u0645 \u0628\u0646\u0645\u0637 \u062d\u064a\u0627\u0629 \u0635\u062d\u064a \u0648\u0627\u0633\u062a\u0634\u0627\u0631\u0629 \u0627\u0644\u0637\u0628\u064a\u0628 \u0639\u0646\u062f \u0627\u0644\u062d\u0627\u062c\u0629.\";\n        }\n\n        resultRange.innerHTML =\n          '\u0627\u0644\u0646\u0633\u0628\u0629 \u0627\u0644\u062a\u0642\u0631\u064a\u0628\u064a\u0629 \u0627\u0644\u0645\u062d\u0633\u0648\u0628\u0629: <strong>\u2248 ' + percent + '%</strong>';\n      } catch (err) {\n        console.error(err);\n        resultBox.className = \"result result--risk\";\n        resultBadge.textContent = \"\u062e\u0637\u0623\";\n        resultText.textContent = \"\u062d\u062f\u062b \u062e\u0637\u0623 \u0623\u062b\u0646\u0627\u0621 \u0645\u0639\u0627\u0644\u062c\u0629 \u0627\u0644\u0637\u0644\u0628. \u0627\u0644\u0631\u062c\u0627\u0621 \u0627\u0644\u0645\u062d\u0627\u0648\u0644\u0629 \u0645\u0631\u0629 \u0623\u062e\u0631\u0649.\";\n        resultRange.innerHTML = '\u0627\u0644\u0646\u0633\u0628\u0629 \u0627\u0644\u062a\u0642\u0631\u064a\u0628\u064a\u0629: <strong>\u063a\u064a\u0631 \u0645\u062a\u0627\u062d\u0629</strong>';\n      } finally {\n        btn.disabled = false;\n      }\n    });\n  </script>\n</body>\n</html>\n"

def _load_model():
    data = base64.b64decode(_MODEL_PKL_B64.encode("ascii"))
    return joblib.load(BytesIO(data))

app = FastAPI(title="Heart Diagnosis AI")

# Load at import time (simple). If you prefer lazy-loading, move into startup event.
model = _load_model()

class PredictRequest(BaseModel):
    Age: float = Field(..., ge=0, le=130)
    Sex: str
    ChestPainType: str
    RestingBP: float = Field(..., ge=0, le=400)
    Cholesterol: float = Field(..., ge=0, le=1000)
    MaxHR: float = Field(..., ge=0, le=300)
    ExerciseAngina: str
    Oldpeak: float = Field(..., ge=-10, le=20)
    ST_Slope: str

from fastapi.responses import HTMLResponse

@app.get("/", response_class=HTMLResponse)
def home():
    html = """
<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Heart Diagnosis AI</title>
<style>
body{font-family:Arial;background:#0b1220;color:#e8eefc;text-align:center;padding:40px}
.card{background:#121a2b;padding:25px;border-radius:12px;max-width:700px;margin:auto}
a{color:#8fb1ff}
</style>
</head>
<body>
<div class="card">
<h1>نظام تشخيص أمراض القلب</h1>
<p>مشروع ذكاء اصطناعي للتنبؤ باحتمالية الإصابة بمرض القلب</p>
<p><b>تنبيه:</b> هذا النظام لأغراض تعليمية فقط</p>
<hr>
<p>
<a href="/docs">Swagger</a> |
<a href="/redoc">ReDoc</a>
</p>
</div>
</body>
</html>
"""
    return HTMLResponse(content=html, status_code=200)

@app.post("/predict")
async def predict(payload: PredictRequest):
    try:
        data = payload.model_dump()

        # ---- Encoding (must match training) ----
        sex = 1 if data["Sex"] == "M" else 0

        # Common label-encoding used for this dataset:
        cp_map = {"TA": 0, "ATA": 1, "NAP": 2, "ASY": 3}
        if data["ChestPainType"] not in cp_map:
            return JSONResponse({"error": f"Invalid ChestPainType: {data['ChestPainType']}"}, status_code=400)
        cp = cp_map[data["ChestPainType"]]

        exang = 1 if data["ExerciseAngina"] == "Y" else 0

        slope_map = {"Up": 0, "Flat": 1, "Down": 2}
        if data["ST_Slope"] not in slope_map:
            return JSONResponse({"error": f"Invalid ST_Slope: {data['ST_Slope']}"}, status_code=400)
        slope = slope_map[data["ST_Slope"]]

        features = np.array([[ 
            float(data["Age"]),
            float(sex),
            float(cp),
            float(data["RestingBP"]),
            float(data["Cholesterol"]),
            float(data["MaxHR"]),
            float(exang),
            float(data["Oldpeak"]),
            float(slope),
        ]], dtype=float)

        # Predict probability of class 1 (heart disease)
        if hasattr(model, "predict_proba"):
            proba_1 = float(model.predict_proba(features)[0][1])
        else:
            # fallback for models without predict_proba
            pred = float(model.predict(features)[0])
            proba_1 = pred

        label = int(proba_1 >= 0.5)
        return JSONResponse({"label": label, "probability": proba_1})
    except Exception as e:
        return JSONResponse({"error": str(e)}, status_code=400)

# For local run:
#   uvicorn app:app --reload
